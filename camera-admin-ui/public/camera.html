<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="Tizen basic template generated by Tizen Web IDE"/>

    <title>Camera Viewer</title>

    <script>
        var lib;

        var serverInfo = {
            ip: window.location.hostname || 'localhost', // <-- Server IP
            port: window.location.port === '3000' ? '3004' : window.location.port,
        };

        var load_lib = function load_lib() {
            var xhr = new XMLHttpRequest();
            var url = 'http://' + serverInfo.ip + ':' + serverInfo.port + '/lib.js';
            xhr.open('GET', url, true);
            xhr.responseType = 'text';
            xhr.onload = function() {
              if (xhr.status === 200) {
                var moduleCode = xhr.responseText;
                lib = eval(moduleCode);
              }
            };
            xhr.send();
        };

        var reload = (callback, error) => {
            load_lib();
            var xhr = new XMLHttpRequest();
            const url = 'http://' + serverInfo.ip + ':' + serverInfo.port + '/reload';
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function () {        // ready state event, will be executed once the server send back the data
                if (xhr.readyState === xhr.DONE) {
                    if (xhr.status === 200) {
                        callback()
                    } else {
                        error('Error ' + xhr.status, new Error(xhr.status))
                    }
                }
            };
            xhr.onerror = function (e) {
                error(xhr.statusText, e);
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }

        var getInfo = (callback, error) => {
            var xhr = new XMLHttpRequest();
            const url = 'http://' + serverInfo.ip + ':' + serverInfo.port + '/info'+'?width=' + window.screen.width + '&height=' + window.screen.height;
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function () {        // ready state event, will be executed once the server send back the data
                if (xhr.readyState === xhr.DONE) {
                    if (xhr.status === 200) {
                        callback(JSON.parse(xhr.responseText))
                    } else {
                        error('Error ' + xhr.status, new Error(xhr.status))
                    }
                }
            };
            xhr.onerror = function (e) {
                error(xhr.statusText, e);
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }
    </script>
    <style>

.container {
  position: relative;
  text-align: center;
  color: white;
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

/* Centered text */
.centered {
  font-size: 200px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
} 

    </style>
</head>

<body>
 <div class="container">
<table id="canvas" BGCOLOR="#000000" BORDER=0 CELLSPACING=0 CELLPADDING=0>
</table>
  <div class="centered" id="notice"></div>
</div> 
</body>
<script type="text/javascript" src="jsmpeg.min.js"></script>
<script type="text/javascript">
    reload(() => getInfo((resp) => {
        notice = document.getElementById("notice");

        document.addEventListener('keydown', (event) => {
          var keyValue = event.key;
          var codeValue = event.code;
          notice.innerHTML = keyValue;
          if ( keyValue >= '0' && keyValue <= '9' ) {
             lib.sel(keyValue);
          } else if ( keyValue == 'ArrowUp' || keyValue == '+' ) {
             notice.innerHTML = '+';
             lib.next();
          } else if ( keyValue == 'ArrowDown' || keyValue == '-' ) {
             notice.innerHTML = '-';
             lib.prev();
          }
        }, false);

        lib.render(resp);
        // const mode = resp.mode;
        // let scalefactor = Math.sqrt(mode);
        // currentChannel = resp.currentChannel;
        // channelCount = resp.channelCount;
        // var notice = document.getElementById("notice");
        // notice.innerHTML = currentChannel + " of " + channelCount;
        // var frames = 0;
        // 
        // const table = document.getElementById("canvas");
        // const trs = [];
        // let tds = [];
        // for (let i = 1; i < mode + 1; i++) {
        //     if (i !== 1 && ((i - 1) % (scalefactor) === 0)) {
        //         trs.push('<tr>' + tds.join('\n') + '</tr>');
        //         tds = [];
        //     }
        //     tds.push('<td> <canvas id="canvas' + i + '"/> </td>')
        // }
        // trs.push('<tr>' + tds.join('\n') + '</tr>');
        // table.innerHTML = trs.join('\n')
        // for (let i = 0; i < mode; i++) {
        //     const url = 'ws://' + serverInfo.ip + ':' + (9999 + i);
        //     new JSMpeg.Player(url, {
        //         canvas: document.getElementById('canvas' + (i + 1)),
        //         onVideoDecode: function ondecode( ) { if ( frames == 60 ) { notice.innerHTML = ""; } else if ( frames < 60 ) { frames = frames + 1 } },
        //         //poster: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Sunflower_from_Silesia2.jpg/1600px-Sunflower_from_Silesia2.jpg?20091008132228',
        //         //onPlay: function a( ) { notice.innerHTML = "a" },
        //         //onPause: function b( ) { notice.innerHTML = "b" },
        //         //onEnded: function c( ) { notice.innerHTML = "c" },
        //         //onStalled: function d( ) { notice.innerHTML = "d" },
        //         //onSourceEstablished: function e( ) { notice.innerHTML = "e" },
        //         //onSourceCompleted: function f( ) { notice.innerHTML = "f" },
        //     })
        // }
    }));
</script>
</html>
